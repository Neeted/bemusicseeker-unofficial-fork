# BeMusicSeeker Unofficial Fork

[![Japanese](https://img.shields.io/badge/lang-Japanese-blue.svg)](README.ja.md)
[![English](https://img.shields.io/badge/lang-English-red.svg)](README.md)
![header](docs/img/header.jpg)

## 概要

本プロジェクトは `Sayaka / 黒皇帝` 氏の [BeMusicSeeker-installer](https://github.com/SayakaIsBaka/BeMusicSeeker-installer) に同梱されている `BeMusicSeeker.exe` を `ILSpy` にてデコンパイルし、改修・再構築を施した非公式版です。

オリジナルバイナリの作者である [`@rib_2_bit`](https://x.com/rib_2_bit) 氏から直接の許諾を得ずにフォークを行っておりますが、元バイナリが MIT License の下で公開されていることに基づき、派生版の作成および公開は問題ないと判断しています。

**【重要】本リポジトリについて**
オリジナルのソースコードは非公開のままであったと認識しており、本プロジェクトにおいてもデコンパイルによって得られたソースコードそのものは（大部分を）リポジトリに含めていません。
本リポジトリは事実上、**「改修済みリリースパッケージ（バイナリ）の配布」** と **「新規に追加・作成した一部のスクリプトや差分コードの公開」** を目的としたリポジトリとして運用されます。

## 導入手順

1. **[Everything 1.5 Alpha (x64)](https://www.voidtools.com/everything-1.5a/) の導入**
    - ※ 非導環境でも動作しますが、起動高速化の恩恵が最大限に発揮されません。導入後、BMS関連ファイルが存在するディレクトリのデータベース構築が完了し、検索が可能になったことを確認してください。
2. **リリース版のダウンロード**
    - [Release](https://github.com/Neeted/bemusicseeker-unofficial-fork/releases) ページから最新版をダウンロードし、任意のディレクトリへ展開・配置してください。インストール作業は不要なポータブルアプリとして動作します。
3. **設定の自動引き継ぎ**
    - 初回起動時、既に従来の BeMusicSeeker がインストールされている環境であれば、設定を自動的に引き継ぎます。
    - 引き継がれた設定は配置先の `.\config\user.config` に保存されるため、元の BeMusicSeeker 本体の動作には影響を及ぼしません。
4. **使い方と新機能について**
    - 基本的な使い方の説明は割愛します。また、新機能に関する詳細なドキュメントは現在未整備です。以下の「変更概要」を参考にしてください。
    - `LaunchWithInfoLog.bat` から起動すると、通常よりも詳細な `[INFO]` レベルのログが `application.log` に出力されます。動作の調査やトラブルシューティングに役立ちます。ログの見方については [ログレベル INFO ガイド](docs/log-level-info-guide.md) を参照してください。

## 変更概要

**※ 最も危惧しているのはBMS関連のデータベースやファイルの破壊です。導入・利用は自己責任にてお願いいたします。**

1. **初期化高速化**
    - `Everything 1.5a` 必須（元のファイル列挙もかなり高速でしたが、1000万ファイル級の環境に対応するためEverythingによる検索を採用）
    - ファイル列挙以外の処理群にも手を入れています（恐らくバグはないはず…）
2. **推定先への移動高速化**
    - 処理遅延の主要因だった移動ごとのUI更新を、バッチ処理寄りに調整しました
3. **HTTPリクエストでのUser-Agentヘッダ付与**
    - 一部の難易度表サイトにおいて発生していた `403 Forbidden` の問題に対処
4. **難易度表リロード時のタイムアウト延長（30秒 → 300秒）**
    - スプレッドシート等で管理されている巨大な難易度表では、レスポンスに30秒以上かかるケースがあったため
5. **左サイドバーの上下二段化**
    - 大量の難易度表を登録している環境でのUI操作性を向上
6. **プレイリストサマリーの追加**
    - 未所持譜面が増えた際にすぐ気が付けるようにしました
    - 完全所持/未所持有での絞り込み機能の追加
    - 右クリックメニューから表の単体リロードができるように追加
7. **導入先推定高速化**
    - ロジック自体は旧版から踏襲しつつ、ハッシュ値などを用いて探索速度を強化
8. **同梱追加譜面の差分導入対応**
    - 従来は「既所持譜面を含むフォルダ」の場合、未所持の追加譜面のインストール先が推定されなかった問題を修正
9. **スマート上書きモード追加（デフォルト有効）**
    - 同梱されている音源やBGAなどを導入する際、新しいファイルを古いファイルで上書きしてしまわないように、更新日時間での比較確認を行うように変更
10. **保留画面での実ファイル削除対応**
    - インストール済みの差分実ファイルを、保留画面上からも直接削除できる要件への対応
11. **差分導入先の手動入力許可**
    - 推定に失敗した場合の救済措置として、既所持BMSフォルダのパスを手動で入力可能にしました
    - ※たまにしか使用しない想定のため、「第二候補のサジェスト」のような便利機能は省いています。また、セルを編集しようとクリックした際に再生が始まってしまう既知の仕様があります。
12. **ポータブルアプリ化**
    - 初回起動時、既存のBeMusicSeekerがシステムにインストール済みの場合は、その設定ファイルを自動的に引き継ぐようにしました
13. **推定難易度表/リコメンド表（自動更新含む）の復活**
    - 難易度表情報の取得先・依存先を [DARKSABUN](https://darksabun.club/) へ変更（※更新されない前提であればローカル保持でも良かったかも）
14. **「インストール先を開く」機能の追加**
    - 保留画面のツリーや明細の右クリックメニューから、推定先や既所持ファイルの導入先フォルダを直接開けるようにしました。
15. **保留画面における「マージ先を推定」機能の追加**
    - 既所持のBMS譜面に対し、リソース（音源やBGAなど）の修正パッチを適用しやすくするための機能です。
    - インストール済みの譜面であっても意図的に導入先を再推定させることで、譜面自体に変更がない場合でもリソースのみを上書き更新することが可能になります。
16. **重複ファイルチェック画面の微修正**
    - 3つ以上の重複が存在する場合に警告文が複数行表示されていた問題を修正し、重複警告を1件に集約しました。
    - 重複している譜面の行は、背景色を薄い赤色でハイライトするように変更しました。
    - （※スマート上書きモードの仕様はここにも影響しています。詳細は別途ドキュメント化が推奨されます。）
17. **多言語対応の強化**
    - 英語、フランス語の対応強化に加え、新たに中国語（簡体字）、中国語（繁体字）、韓国語に対応しました。
18. **アプリの更新チェック機能（簡易版）の実装**
    - 起動時、リポジトリに新しいバージョンが存在する場合にダイアログを表示してお知らせします。
    - ※簡易的な通知機能のため、自動アップデート機能はありません。該当のダイアログが表示された場合は、手動で最新版のダウンロードと上書き更新をお願いします。

## TODO

現状で思いついたアイデアのメモ。思いついた順。優先度は混在。

1. Shift_JIS範囲外文字を含むファイルパスを一括除外、または編集できる画面の追加
   - 現状 [Shift_JIS 非対応パスによる song テーブル往復更新](docs/sjis-path-validation-note.md) の問題が発生しており不整合を解消したい。ただし、単にDBへの登録を弾くだけではパスの問題に気づく契機がなくなるため、不整合解消前にこの確認・編集画面を用意したい。
2. 「マージ先を推定」機能の強化
    - 移動処理の前に「移動を行う意味があるか（移動元のファイルの方が新しいか、追加ファイルが存在するかなど）」を検証し、意味がない場合は推定先をセットしない挙動が望ましい。
    - スマート上書きモードの結果（実際にどれだけ上書きされたか）をユーザーが確認できるUIがあると良い。（現在は`[INFO]`レベルのログには出力しているが、可読性が低いため）
3. BMS Score Viewer の未登録譜面確認画面
    - （5MB超などのアップロード制限で送れなかった）未登録md5を自前でローカルDBに持つべきか？ そうしないと未登録画面のリストから延々と消えない問題がある。
    - 基本的には [bms-score-uploader](https://github.com/Neeted/bms-score-uploader) のアプローチを踏襲すれば良さそう。
4. LR2IRからライバルデータをダウンロードし、データベース化・配置する機能
5. クリアランプビューワー機能
6. コース内容の表示、および順番編集機能
7. ハードコードされているURL群のうち、リンク切れとなっているものの代替
    - LR2IRキャッシュ系はデータの用意や更新が大変なため、理想的には「プロキシサーバを用意し、最終更新から24時間経過していた場合のみLR2IR本体へフェッチしにいく」といった仕組みが良いかもしれない。
8. LR2の `song.db` の空欄を埋めても問題ないかの調査
   - songテーブルの一部カラムが意図的にNULLになっている可能性がある（LR2自体の譜面解析処理を走らせるためのトリガー用途、またはパースエラーを弾く目的？）。仮にそうだとしても、BPM等の一部の値は埋めても問題ない気がするので要検証。
9. bmson フォーマット管理機能
    - 実装するならLR2のデータ系譜とは完全に切り離して、独自DBを立てた方が楽になりそう。
    - **せめて保留に入れたときにbmsonが含まれている警告くらいは出したい。**
10. アーカイブ（zip等）をドラッグ＆ドロップして導入する際、中身のファイルの更新日時が復元されない問題の修正
    - スマート上書きモードの判定精度に関わるため改善すべき項目。
11. Everything 1.5a 連携失敗時の警告ダイアログの表示
12. 0ノーツチェック関係の強化
    - 差分導入の時点で0ノーツ判定を行い、自動で `.bmx` 拡張子への変更を提示する挙動が好ましいか？
    - `bmx` 化する際の名前重複警告が出た後、リスト明細からは消えるものの、実態として拡張子が変更されないままになる仕様がある。ハッシュを比較し「重複しているなら新規リネームしようとした方を削除する」「重複していないなら自動リネームを続行する」といった処理が望ましい。
    - 既存の0ノーツチェック処理では、一部の譜面で実際に0ではないのに「0判定」になってしまうケースがある（LN関係のパーサー処理が原因の可能性）。
13. UI更新タイミングの整理
    - 高速化のために更新処理を抑制する方針にした影響で、「ツリーの選択を切り替えないとリスト明細が更新されない」といったパターンの副作用が生じている。
14. 難易度表パッケージ作成機能
    - 知的財産権などの諸問題をあえて一旦無視すると、主要な難易度表の「一括パッケージ」を簡単に作れる機能が存在した方が利用者の参入障壁が大きく下がる。
    - パッケージ作成用の作業ディレクトリを用意し、差分でコピーできるようにすると良さそう。
    - 「パッケージ差分更新用のパッチ出力機能」は考慮の難易度が高いため（既存リソースが削除された場合の同期など）、一旦考えず、まずは「難易度表全体のzipファイルを作る機能」のみに絞るのが妥当。
    - いかなる場合でも、「難易度表に掲載されている特定の譜面だけを抽出・梱包し、元々のBMS作者が同梱していた他の譜面ファイル（別の難易度など）を除外する」ような処理は絶対に実装しない。（過去に出回っていた発狂BMSパッケージ等で見られた手法だが、制作者への敬意に欠けるため。）
15. デコンパイルで失われたローカル変数名のリファクタリング
    - 変数名が `list1, list2...` や `item1, item2...` といった無意味な命名になってしまっている箇所が多数あり、可読性が致命的（AIによるコード理解時にも支障が出る）なため整理が必要。
16. 「リコメンド（自動更新）」を導入している状態でプレイリストの全リロード（起動時または手動実行）が行われると、リコメンド表の更新だけが終わらずにハングアップする問題の調査
    - 初期化周りのコードを弄っていたら再現しなくなった気もする。とりあえず一時的な対症療法として `ServicePointManager.DefaultConnectionLimit = 12;` に設定している。
    - 根本的には `HttpWebRequest` ではなく `HttpClient` へ移行した方が良さそうだが、コード規模的にすぐには難しい。
17. カスタムフォルダ出力機能の実装状態の確認
    - 具体的な改善案があるわけではないが、重要なコア機能なので動作仕様を再確認しておく必要がある。

## ライセンスの適用範囲

本リポジトリにて新規作成、および公開されているファーストパーティのソースコード（各種スクリプトなど）には、元バイナリに準じて **MIT License** が適用されます。

- **新規作成コード（公開スクリプト等）**: MIT License ([`LICENSE`](LICENSE) を参照)
- **サードパーティ製バイナリ・フォント・SDK等**: 本リリースパッケージに含まれるその他の外部コンポーネントは、それぞれの提供元が定めるライセンスおよび利用規約に従います。
- 条項が競合する場合、そのコンポーネントについては提供元のライセンス・注意情報が優先されます。

**監査台帳とサードパーティ条項の詳細について：**

- [`ThirdPartyNotices.ja.txt`](ThirdPartyNotices.ja.txt): 各依存コンポーネントごとの注意事項や法的リスク状態のリスト
- [`third_party/licenses/`](third_party/licenses/): 同梱されている、プロプライエタリなコンポーネントやフォント等の利用許諾条項の原文ファイル

### BASSに関する重要事項

本プロジェクトのリリースパッケージには、MITライセンスの適用範囲外となる `BASS` 関連のオーディオコンポーネントが含まれています。
これらのバイナリ群はオープンソースではなく、商用利用を行う場合には提供元（un4seen等）からの適切な商用ライセンスの取得が義務付けられています。非商用かつ個人利用の範囲であればフリーウェアとして許可される場合がありますが、利用の際は常にネイティブ版BASSおよび `Bass.Net` ラッパーの公式ライセンス条項を遵守してください。
